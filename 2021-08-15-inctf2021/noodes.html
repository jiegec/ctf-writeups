<!-- https://raw.githubusercontent.com/mkdocs/mkdocs/refs/heads/master/mkdocs/themes/mkdocs/base.html -->
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://jia.je/ctf-writeups/2021-08-15-inctf2021/noodes.html">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>flagchecker - CTF Writeups by @jiegec</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <!-- added by @jiegec begin -->
        <link href=" https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism.min.css " rel="stylesheet">
        <!-- added by @jiegec end -->
        <!-- added by @jiegec begin -->
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/components/prism-core.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/autoloader/prism-autoloader.min.js"></script>
        <!-- added by @jiegec end -->

      <!-- added by @jiegec begin -->
      <script defer src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
      </script>
      
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT"></script>
      <script>
          window.dataLayer = window.dataLayer || [];
          function gtag() { dataLayer.push(arguments); }
          gtag('js', new Date());
      
          gtag('config', 'G-3109FRSVTT');
      </script>
      
      <script src="https://analytics.jiege.pro/api/script.js" data-site-id="1" defer></script>
      <!-- added by @jiegec end --> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../index.html">CTF Writeups by @jiegec</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../index.html" class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../misc/solution.html" class="nav-link">Writeups by Solution</a>
                            </li>
                            <li class="nav-item">
                                <a href="../misc/pyjail.html" class="nav-link">Pyjail</a>
                            </li>
                            <li class="nav-item">
                                <a href="../puppeteer/index.html" class="nav-link">Redbud Puppeteer</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#flagchecker" class="nav-link">flagchecker</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="flagchecker">flagchecker</h1>
<p>这题主要是 SuperFashi 做的，我提供了一些思路的协助。</p>
<p>也是一道逆向题。有两个进程：父进程用 inotify 监控一个目录，然后子进程按照输入的字符串进行文件操作；最后看父进程观测到的 inotify 事件是否是预期的。子进程可以进行的操作有：</p>
<ol>
<li>打开一个文件，fd 入栈</li>
<li>fd 出栈并 fclose</li>
<li>fwrite 栈顶</li>
<li>删除文件</li>
<li>chmod 文件</li>
<li>删除文件夹</li>
<li>创建文件夹</li>
<li>结束</li>
</ol>
<p>首先要找到预期的文件访问历史，说成人话，就是：</p>
<pre class="highlight"><code>delete file tT
delete file 1B
close file HX
chmod dir oQ
...
chmod file rl
delete file f1
delete dir yO
chmod file RN
write file Bl
write file Lx
write file Pd
write file JH
write file 1V
close file Bl
close file Lx
close file Xt
close file 93
close file uj
close file Cx
close file Pd
close file JH
close file Xl
close file EZ
close file 1V
close file KP</code></pre>
<p>如果按照栈的访问过程，最后这一段是不可能实现的：写 Bl 写 Lx 最后又是关 Bl 关 Lx，不合常理。</p>
<p>于是想到是不是因为 fwrite 有缓存，试了一下，果然：</p>
<pre class="highlight"><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

int main() {
  char buffer[] = "test";
  FILE *a = fopen("a", "a+");
  fwrite(buffer, 1, sizeof(buffer), a);
  FILE *b = fopen("b", "a+");
  fwrite(buffer, 1, sizeof(buffer), b);
  return 0;
}</code></pre>
<pre class="highlight"><code class="language-shell">$ strace ./test
openat(AT_FDCWD, "a", O_RDWR|O_CREAT|O_APPEND, 0666) = 3
newfstatat(3, "", {st_mode=S_IFREG|0644, st_size=33735, ...}, AT_EMPTY_PATH) = 0
openat(AT_FDCWD, "b", O_RDWR|O_CREAT|O_APPEND, 0666) = 4
newfstatat(4, "", {st_mode=S_IFREG|0644, st_size=16445, ...}, AT_EMPTY_PATH) = 0
write(4, "test\0", 5)                   = 5
write(3, "test\0", 5)                   = 5
exit_group(0)                           = ?</code></pre>
<p>可以看到，操作顺序是 打开 a，打开 b，写 b，写 a。这意味着，如果 fwrite 没有达到一定的 buffer（测了一下，是 4096 个字节），那么它不会 flush，当 main 退出的时候，libc 会找到所有打开的 FILE *，然后按照打开顺序的逆序进行 flush。注意，这个 flush 是在用户态实现的。但是，怎么保证写 b 写 a 以后关 b 关 a 这个顺序呢？如果在用户态里面，调用 fclose，那么 close 之前也会立马 flush，不能达到目标的顺序。</p>
<p>于是，我自己测试了一下，看看如果用户态程序不关，让系统关，会怎么样：</p>
<pre class="highlight"><code class="language-shell">$ inotifywait -m a b
Setting up watches.
Watches established.
# run in another shell
$ ./test
# back to inotifywait
a OPEN 
b OPEN 
b MODIFY 
a MODIFY 
b CLOSE_WRITE,CLOSE 
a CLOSE_WRITE,CLOSE</code></pre>
<p>惊喜地发现，OS 回收进程的时候，也是按照打开顺序的逆序进行 close。这样的话，回到题目，我们就找到了解决办法：在 fwrite Bl Lx 等等以后，让子进程正常退出，这个时候 libc 会 flush 掉 fwrite 的内容，从而生成 write Bl write Lx 的记录；然后，OS 回收进程，关掉文件，就会生成 close Bl close Lx 的记录。这样就把这题解决了。</p></div>

                <!-- added by @jiegec begin -->
                <div class="col-md-3"></div>
                <div class="col-md-9">
                  <script src="https://giscus.app/client.js"
                      data-repo="jiegec/ctf-writeups"
                      data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE1MzAxODQ="
                      data-category="General"
                      data-category-id="DIC_kwDOCQgqyM4CvbYX"
                      data-mapping="pathname"
                      data-strict="1"
                      data-reactions-enabled="1"
                      data-emit-metadata="0"
                      data-input-position="top"
                      data-theme="light"
                      data-lang="en"
                      data-loading="lazy"
                      crossorigin="anonymous"
                      async>
                  </script>
                </div>
                <!-- added by @jiegec end -->
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2025 Jiajie Chen</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
