<!-- https://raw.githubusercontent.com/mkdocs/mkdocs/refs/heads/master/mkdocs/themes/mkdocs/base.html -->
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://jia.je/ctf-writeups/2025-09-04-nullcon-berlin-hackim-2025-ctf/magntic-tape.html">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Magnetic tape - CTF Writeups by @jiegec</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <!-- added by @jiegec begin -->
        <link href=" https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism.min.css " rel="stylesheet">
        <!-- added by @jiegec end -->
        <!-- added by @jiegec begin -->
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/components/prism-core.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/autoloader/prism-autoloader.min.js"></script>
        <!-- added by @jiegec end -->

      <!-- added by @jiegec begin -->
      <script defer src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
      </script>
      
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT"></script>
      <script>
          window.dataLayer = window.dataLayer || [];
          function gtag() { dataLayer.push(arguments); }
          gtag('js', new Date());
      
          gtag('config', 'G-3109FRSVTT');
      </script>
      
      <script src="https://analytics.jiege.pro/api/script.js" data-site-id="1" defer></script>
      <!-- added by @jiegec end --> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../index.html">CTF Writeups by @jiegec</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../index.html" class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../misc/solution.html" class="nav-link">Writeups by Solution</a>
                            </li>
                            <li class="nav-item">
                                <a href="../misc/pyjail.html" class="nav-link">Pyjail</a>
                            </li>
                            <li class="nav-item">
                                <a href="../puppeteer/index.html" class="nav-link">Redbud Puppeteer</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#magnetic-tape" class="nav-link">Magnetic tape</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="magnetic-tape">Magnetic tape</h1>
<pre class="highlight"><code>We asked an LLM to build a web app to manage the magnetic tapes archives in our datacenter. We've asked it to make sure it's secure. Could you please do a bit of paid pentestingsecurity research on it? kthxbye

http://52.59.124.14:5005</code></pre>
<p>In attachment, the source code of a web server is provide. The flag endpoint is protected by cookie session:</p>
<pre class="highlight"><code class="language-python">@app.route("/get-flag")
@login_required
def get_session():
    if not session["is_admin"]:
        abort(401)
    flag_path = os.getenv("FLAG_PATH", "flag/flag.txt")
    with open(flag_path) as f:
        return f.read()</code></pre>
<p>Therefore, we must fake a cookie that gives <code>is_admin=True</code>. Here is how the cookie session saved and loaded:</p>
<pre class="highlight"><code class="language-python">import base64, binascii
import logging
import os

from flask.sessions import SessionMixin, SessionInterface
from flask import Flask, Response, Request

from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
from universalCRC import crc
from random import SystemRandom

import json

_logger = logging.getLogger(__name__)

class CustomSession(dict, SessionMixin):
    pass

class CustomSessionInterface(SessionInterface):

    _KEY_LENGTH = 32
    _BLOCK_LENGTH = 16
    _IV_LENGTH = _BLOCK_LENGTH
    _MAC_LENGTH = 8
    _POLY = [  # from the ECMA-182 standard
        62, 57, 55, 54, 53, 52, 47, 46, 45, 40, 39, 38, 37, 35, 33, 32, 31, 29,
        27, 24, 23, 22, 21, 19, 17, 13, 12, 10, 9, 7, 4, 1, 0,
    ]
    _POLY = sum(1 &lt;&lt; d for d in _POLY)

    def __init__(self, key=None):
        self._random_generator = SystemRandom()
        if key is None:
            key = os.getenv("SECURE_SESSION_KEY")
        if key is None:
            key = self._random_generator.randbytes(self._KEY_LENGTH)
        else:
            key = base64.b64decode(key)
        self._key = key

    def open_session(self, app: Flask, request: Request):
        cookie = request.cookies.get(app.config["SESSION_COOKIE_NAME"])
        if cookie is None:
            return CustomSession()
        try:
            session_data = base64.b64decode(cookie)
            data = self._decrypt(session_data).decode("utf-8")
            return CustomSession(json.loads(data))
        except Exception as e:
            _logger.warning("failed to load session data: {}".format(e))
            return CustomSession()

    def save_session(
        self, app: Flask, session: SessionMixin, response: Response
    ) -&gt; None:
        session_data = json.dumps(dict(session))
        data = self._encrypt(session_data.encode("utf-8"))
        response.set_cookie(app.config["SESSION_COOKIE_NAME"], base64.b64encode(data).decode("ascii"))

    def _encrypt(self, data: bytes):
        nonce = self._random_generator.randbytes(self._IV_LENGTH)
        cipher = Cipher(algorithms.AES(self._key), modes.CTR(nonce))
        encryptor = cipher.encryptor()
        mac = self._crc64(data)
        return nonce + encryptor.update(data + mac) + encryptor.finalize()

    def _decrypt(self, data: bytes):
        minimum_ciphertext_length = self._IV_LENGTH + self._MAC_LENGTH
        if len(data) &lt; minimum_ciphertext_length:
            raise ValueError("ciphertext too short to decrypt, was {} bytes, at least {} required".format(
                len(data),
                minimum_ciphertext_length
            ))

        iv = data[0:self._IV_LENGTH]
        data = data[self._IV_LENGTH:]

        cipher = Cipher(algorithms.AES(self._key), modes.CTR(iv))
        decryptor = cipher.decryptor()
        data = decryptor.update(data) + decryptor.finalize()

        assert len(data) &gt; self._MAC_LENGTH

        transmitted_mac = data[-self._MAC_LENGTH:]
        data = data[:-self._MAC_LENGTH]
        mac_of_received_data = self._crc64(data)
        if mac_of_received_data != transmitted_mac:
            raise ValueError("decryption failed: invalid MAC. Most likely someone has tampered with the transmitted data.")

        return data

    def _crc64(self, data):
        check_value = crc.compute_CRC(binascii.hexlify(data).decode("ascii"), self._POLY, 0, 0, 64, False, False)
        return check_value.to_bytes(8, "big")</code></pre>
<p>The algorithm is:</p>
<ol>
<li>Generate random key and IV</li>
<li>Encode session data to JSON</li>
<li>Append crc64 protecting the JSON</li>
<li>Encrypt JSON + crc64 using AES CTR mode</li>
</ol>
<p>AES CTR works by encrypting <code>IV + counter</code> and XORs the result into plaintext:</p>
<pre class="highlight"><code>AES-CTR-Encrypt(key, plaintext, iv, ctr) = AES-ECB-Encrypt(key, iv || ctr) xor plaintext</code></pre>
<p>So we can change the decrypted plaintext into arbitrary text <code>arbitrary</code> by:</p>
<pre class="highlight"><code>AES-CTR-Decrypt(key, AES-CTR-Encrypt(key, plaintext, iv, ctr) xor plaintext xor arbitrary, iv, ctr)
= AES-ECB-Encrypt(key, iv || ctr) xor AES-CTR-Encrypt(key, plaintext, iv, ctr) xor plaintext xor arbitrary
= AES-ECB-Encrypt(key, iv || ctr) xor AES-ECB-Encrypt(key, iv || ctr) xor plaintext xor plaintext xor arbitrary
= arbitrary</code></pre>
<p>So the next thing is to break crc protection. There is a property of crc that:</p>
<pre class="highlight"><code>CRC(x xor y) = CRC(x) xor CRC(y)</code></pre>
<p>If x and y has the same length. Therefore, we only need to:</p>
<ol>
<li>Find the format of the plaintext, e.g. <code>{"user_id": "62dd4d7e-2ef0-4515-849c-cc1d8bed5370", "is_admin": false}</code>, let's call it <code>x</code></li>
<li>Choose our arbitrary text called <code>y</code>: <code>{"user_id": "62dd4d7e-2ef0-4515-849c-cc1d8bed5370", "is_admin": true }</code> that has the same length, but <code>"false"</code> becomes <code>"true "</code>, not the extra whitespace</li>
<li>Compute <code>x xor y</code>, and it should be xor-ed into AES-CTR encrypted data</li>
<li>Compute <code>crc(x xor y)</code>, and it should be xor-ed into the CRC</li>
</ol>
<p>Proof of concept:</p>
<pre class="highlight"><code class="language-python">import uuid
import json
from universalCRC import crc
import binascii
from random import SystemRandom
from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes

_KEY_LENGTH = 32
_BLOCK_LENGTH = 16
_IV_LENGTH = _BLOCK_LENGTH
_MAC_LENGTH = 8
_POLY = [  # from the ECMA-182 standard
    62,
    57,
    55,
    54,
    53,
    52,
    47,
    46,
    45,
    40,
    39,
    38,
    37,
    35,
    33,
    32,
    31,
    29,
    27,
    24,
    23,
    22,
    21,
    19,
    17,
    13,
    12,
    10,
    9,
    7,
    4,
    1,
    0,
]
_POLY = sum(1 &lt;&lt; d for d in _POLY)
_random_generator = SystemRandom()
_key = _random_generator.randbytes(_KEY_LENGTH)


def _crc64(data):
    check_value = crc.compute_CRC(
        binascii.hexlify(data).decode("ascii"), _POLY, 0, 0, 64, False, False
    )
    return check_value.to_bytes(8, "big")


def _encrypt(data: bytes):
    nonce = _random_generator.randbytes(_IV_LENGTH)
    cipher = Cipher(algorithms.AES(_key), modes.CTR(nonce))
    encryptor = cipher.encryptor()
    mac = _crc64(data)
    return nonce + encryptor.update(data + mac) + encryptor.finalize()


def _decrypt(data: bytes):
    minimum_ciphertext_length = _IV_LENGTH + _MAC_LENGTH
    if len(data) &lt; minimum_ciphertext_length:
        raise ValueError(
            "ciphertext too short to decrypt, was {} bytes, at least {} required".format(
                len(data), minimum_ciphertext_length
            )
        )

    iv = data[0:_IV_LENGTH]
    data = data[_IV_LENGTH:]

    cipher = Cipher(algorithms.AES(_key), modes.CTR(iv))
    decryptor = cipher.decryptor()
    data = decryptor.update(data) + decryptor.finalize()

    assert len(data) &gt; _MAC_LENGTH

    transmitted_mac = data[-_MAC_LENGTH:]
    data = data[:-_MAC_LENGTH]
    mac_of_received_data = _crc64(data)
    if mac_of_received_data != transmitted_mac:
        raise ValueError(
            "decryption failed: invalid MAC. Most likely someone has tampered with the transmitted data."
        )

    return data


session_data = json.dumps(dict({"user_id": str(uuid.uuid4()), "is_admin": False}))
print(session_data)
data = _encrypt(session_data.encode("utf-8"))

# change "false" to "true "
xor_data = [ord(a) ^ ord(b) for a, b in zip("false", "true ")]
index = session_data.index("false")
xor_data = [0] * index + xor_data + [0]

# new data
data = bytearray(data)
for i in range(_IV_LENGTH, len(data) - _MAC_LENGTH):
    data[i] = data[i] ^ xor_data[i - _IV_LENGTH]
xor_mac = _crc64(bytes(xor_data))
# CRC(x xor y) = CRC(x) xor CRC(y)
for i in range(len(data) - _MAC_LENGTH, len(data)):
    data[i] = data[i] ^ xor_mac[i - (len(data) - _MAC_LENGTH)]
decrypted = _decrypt(data)
print(decrypted.decode())</code></pre>
<p>Output:</p>
<pre class="highlight"><code class="language-json">{"user_id": "657231d8-d647-4e92-a749-79880aacc8b4", "is_admin": false}
{"user_id": "657231d8-d647-4e92-a749-79880aacc8b4", "is_admin": true }</code></pre>
<p>We have successfully passed the validation, while setting <code>is_admin</code> to <code>true</code>. Then, we only need to do the same thing online:</p>
<pre class="highlight"><code class="language-python">import uuid
import json
from universalCRC import crc
import base64
import binascii

_BLOCK_LENGTH = 16
_IV_LENGTH = _BLOCK_LENGTH
_MAC_LENGTH = 8
_POLY = [  # from the ECMA-182 standard
    62,
    57,
    55,
    54,
    53,
    52,
    47,
    46,
    45,
    40,
    39,
    38,
    37,
    35,
    33,
    32,
    31,
    29,
    27,
    24,
    23,
    22,
    21,
    19,
    17,
    13,
    12,
    10,
    9,
    7,
    4,
    1,
    0,
]
_POLY = sum(1 &lt;&lt; d for d in _POLY)


def _crc64(data):
    check_value = crc.compute_CRC(
        binascii.hexlify(data).decode("ascii"), _POLY, 0, 0, 64, False, False
    )
    return check_value.to_bytes(8, "big")


# the cookie is taken from the website
cookie = base64.b64decode("REDACTED")

session_data = json.dumps(dict({"user_id": str(uuid.uuid4()), "is_admin": False}))
data = cookie
# data = _encrypt(session_data.encode("utf-8"))

# change "false" to "true "
xor_data = [ord(a) ^ ord(b) for a, b in zip("false", "true ")]
index = session_data.index("false")
xor_data = [0] * index + xor_data + [0]

# new data
data = bytearray(data)
for i in range(_IV_LENGTH, len(data) - _MAC_LENGTH):
    data[i] = data[i] ^ xor_data[i - _IV_LENGTH]
xor_mac = _crc64(bytes(xor_data))
# CRC(x xor y) = CRC(x) xor CRC(y)
for i in range(len(data) - _MAC_LENGTH, len(data)):
    data[i] = data[i] ^ xor_mac[i - (len(data) - _MAC_LENGTH)]
print(base64.b64encode(data))
# decrypted = _decrypt(data)
# print(decrypted)</code></pre>
<p>Then we can get flag using our crafted cookie:</p>
<pre class="highlight"><code class="language-shell">curl http://52.59.124.14:5005/get-flag -H "Cookie: session=REDACTED"
ENO{null_1s_nu1l_d8683c9163965e2b}</code></pre></div>

                <!-- added by @jiegec begin -->
                <div class="col-md-3"></div>
                <div class="col-md-9">
                  <script src="https://giscus.app/client.js"
                      data-repo="jiegec/ctf-writeups"
                      data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE1MzAxODQ="
                      data-category="General"
                      data-category-id="DIC_kwDOCQgqyM4CvbYX"
                      data-mapping="pathname"
                      data-strict="1"
                      data-reactions-enabled="1"
                      data-emit-metadata="0"
                      data-input-position="top"
                      data-theme="light"
                      data-lang="en"
                      data-loading="lazy"
                      crossorigin="anonymous"
                      async>
                  </script>
                </div>
                <!-- added by @jiegec end -->
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2025 Jiajie Chen</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
