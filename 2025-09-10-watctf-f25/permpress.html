<!-- https://raw.githubusercontent.com/mkdocs/mkdocs/refs/heads/master/mkdocs/themes/mkdocs/base.html -->
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://jia.je/ctf-writeups/2025-09-10-watctf-f25/permpress.html">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>permpress - CTF Writeups by @jiegec</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <!-- added by @jiegec begin -->
        <link href=" https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism.min.css " rel="stylesheet">
        <!-- added by @jiegec end -->
        <!-- added by @jiegec begin -->
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/components/prism-core.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/plugins/autoloader/prism-autoloader.min.js"></script>
        <!-- added by @jiegec end -->

      <!-- added by @jiegec begin -->
      <script defer src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
      </script>
      
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-3109FRSVTT"></script>
      <script>
          window.dataLayer = window.dataLayer || [];
          function gtag() { dataLayer.push(arguments); }
          gtag('js', new Date());
      
          gtag('config', 'G-3109FRSVTT');
      </script>
      
      <script src="https://analytics.jiege.pro/api/script.js" data-site-id="1" defer></script>
      <!-- added by @jiegec end --> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../index.html">CTF Writeups by @jiegec</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../index.html" class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../misc/solution.html" class="nav-link">Writeups by Solution</a>
                            </li>
                            <li class="nav-item">
                                <a href="../misc/pyjail.html" class="nav-link">Pyjail</a>
                            </li>
                            <li class="nav-item">
                                <a href="../puppeteer/index.html" class="nav-link">Redbud Puppeteer</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#permpress" class="nav-link">permpress</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="permpress">permpress</h1>
<pre class="highlight"><code>Written by virchau13

It's kinda like doing your laundry, if you think about it hard enough.
nc challs.watctf.org 2333 </code></pre>
<p>Attachment:</p>
<pre class="highlight"><code class="language-rs">use rand::{seq::SliceRandom, Rng};
use rustc_hash::FxBuildHasher;
use std::{hash::{BuildHasher, Hash}, io::{self, BufRead, Read, Write}};
use simplehash::fnv1a_64;

fn do_hash(x: i32) -&gt; u64 {
    fnv1a_64(&amp;x.to_le_bytes())
}

const HASH_SIZE: usize = 32;

fn test_perm_restricted_memory(perm: &amp;[i32]) -&gt; bool {
    let mut map = [-1i32; HASH_SIZE];
    for x in perm {
        let idx = (do_hash(*x) % HASH_SIZE as u64) as usize;
        if map[idx] == *x {
            // duplicate, fail
            return false;
        } else {
            // not a duplicate, continue
        }
        map[idx] = *x;
    }
    true
}

fn parse_perm(inp: &amp;str) -&gt; Result&lt;Vec&lt;i32&gt;, &amp;'static str&gt; {
    let ans: Vec&lt;i32&gt; = inp.trim().split(' ').map(|x| x.parse::&lt;u32&gt;().unwrap() as i32).collect();
    if ans.len() != 256 {
        return Err("permutation is not of length 256");
    }
    for x in &amp;ans {
        if *x &lt; 0 || 256 &lt;= *x {
            return Err("permutation element out of range");
        }
    }
    if !test_perm_restricted_memory(&amp;ans) {
        return Err("permutation has non-unique elements");
    }
    Ok(ans)
}

fn compose_perms(p1: &amp;[i32], p2: &amp;[i32]) -&gt; Vec&lt;i32&gt; {
    p1.iter().map(|i| p2[*i as usize]).collect()
}

fn main() {
    let mut rng = rand::rng();
    let mut cipherperm: Vec&lt;i32&gt; = (0..256).collect();
    cipherperm.shuffle(&amp;mut rng);
    let stdin = io::stdin();
    let mut line_iter = stdin.lock().lines();
    let mut get_line = || -&gt; String {
        line_iter.next().unwrap().unwrap()
    };
    println!("Welcome to the Permutation Oracle.");
    loop {
        println!("Main Menu");
        println!("1. Give the oracle a permutation");
        println!("2. Guess the secret permutation");
        print!("Enter your choice: ");
        io::stdout().flush().unwrap();
        let choice = get_line();
        let choice: u32 = choice.trim().parse().unwrap();
        if choice == 1 {
            print!("Enter the permutation seperated by spaces: ");
            io::stdout().flush().unwrap();
            let perm_str = get_line();
            let perm = match parse_perm(&amp;perm_str) {
                Err(e) =&gt; {
                    println!("Error: {e}");
                    continue;
                },
                Ok(v) =&gt; v,
            };
            let res = compose_perms(&amp;perm, &amp;cipherperm);
            let i = rng.random_range(0..res.len());
            println!("The oracle has divined... {}", res[i]);
        } else if choice == 2 {
            print!("Enter the permutation seperated by spaces: ");
            io::stdout().flush().unwrap();
            let perm_str = get_line();
            let perm = match parse_perm(&amp;perm_str) {
                Err(e) =&gt; {
                    println!("Error: {e}");
                    continue;
                },
                Ok(v) =&gt; v,
            };
            if perm == cipherperm {
                println!("Good job! Here's your reward: {}", std::env::var("FLAG").unwrap());
            } else {
                println!("Unfortunately, wrong :/");
            }
        }
    }
}</code></pre>
<p>We can send a permutation of <code>0..256</code> to the server, then the server combines the permutation with the oracle and responds with a random element. However, the validation is buggy:</p>
<pre class="highlight"><code class="language-rust">fn test_perm_restricted_memory(perm: &amp;[i32]) -&gt; bool {
    let mut map = [-1i32; HASH_SIZE];
    for x in perm {
        let idx = (do_hash(*x) % HASH_SIZE as u64) as usize;
        if map[idx] == *x {
            // duplicate, fail
            return false;
        } else {
            // not a duplicate, continue
        }
        map[idx] = *x;
    }
    true
}</code></pre>
<p>If we send two values that map to the same bucket in turns, it does not report duplication. So, firstly we need to find the values that belong to the same bucket:</p>
<pre class="highlight"><code class="language-rust">use rand::{seq::SliceRandom, Rng};
use rustc_hash::FxBuildHasher;
use simplehash::fnv1a_64;
use std::{
    hash::{BuildHasher, Hash},
    io::{self, BufRead, Read, Write},
};

fn do_hash(x: i32) -&gt; u64 {
    fnv1a_64(&amp;x.to_le_bytes())
}

const HASH_SIZE: usize = 32;
fn main() {
    let mut buckets = vec![vec![]; HASH_SIZE];
    for i in 0..256 {
        let idx = (do_hash(i) % HASH_SIZE as u64) as usize;
        buckets[idx].push(i);
    }
    for i in 0..HASH_SIZE {
        println!("{}: {:?}", i, buckets[i]);
    }
}</code></pre>
<p>Then, we can generate a sequence of <code>e1, e2, e1, e2, ...</code> to get either <code>oracle[e1]</code> or <code>oracle[e2]</code>. Then, we can use <code>e1, e3, e1, e3, ...</code> to get either <code>oracle[e1]</code> or <code>oracle[e3]</code>. The intersection will be <code>oracle[e2]</code>. Continue the process until we find all elements.</p>
<p>Attack script:</p>
<pre class="highlight"><code class="language-python">from pwn import *

context(log_level="debug")

buckets = {
    0: [5, 37, 69, 101, 133, 165, 197, 229],
    1: [20, 52, 84, 116, 148, 180, 212, 244],
    2: [7, 39, 71, 103, 135, 167, 199, 231],
    3: [22, 54, 86, 118, 150, 182, 214, 246],
    4: [1, 33, 65, 97, 129, 161, 193, 225],
    5: [16, 48, 80, 112, 144, 176, 208, 240],
    6: [3, 35, 67, 99, 131, 163, 195, 227],
    7: [18, 50, 82, 114, 146, 178, 210, 242],
    8: [13, 45, 77, 109, 141, 173, 205, 237],
    9: [28, 60, 92, 124, 156, 188, 220, 252],
    10: [15, 47, 79, 111, 143, 175, 207, 239],
    11: [30, 62, 94, 126, 158, 190, 222, 254],
    12: [9, 41, 73, 105, 137, 169, 201, 233],
    13: [24, 56, 88, 120, 152, 184, 216, 248],
    14: [11, 43, 75, 107, 139, 171, 203, 235],
    15: [26, 58, 90, 122, 154, 186, 218, 250],
    16: [21, 53, 85, 117, 149, 181, 213, 245],
    17: [4, 36, 68, 100, 132, 164, 196, 228],
    18: [23, 55, 87, 119, 151, 183, 215, 247],
    19: [6, 38, 70, 102, 134, 166, 198, 230],
    20: [17, 49, 81, 113, 145, 177, 209, 241],
    21: [0, 32, 64, 96, 128, 160, 192, 224],
    22: [19, 51, 83, 115, 147, 179, 211, 243],
    23: [2, 34, 66, 98, 130, 162, 194, 226],
    24: [29, 61, 93, 125, 157, 189, 221, 253],
    25: [12, 44, 76, 108, 140, 172, 204, 236],
    26: [31, 63, 95, 127, 159, 191, 223, 255],
    27: [14, 46, 78, 110, 142, 174, 206, 238],
    28: [25, 57, 89, 121, 153, 185, 217, 249],
    29: [8, 40, 72, 104, 136, 168, 200, 232],
    30: [27, 59, 91, 123, 155, 187, 219, 251],
    31: [10, 42, 74, 106, 138, 170, 202, 234],
}

oracle = [0] * 256

p = remote("challs.watctf.org", 2333)
# p = process("./target/debug/permpress")

for i in buckets:
    bucket = buckets[i]
    # alternate between pairs
    for j in range(0, len(bucket), 2):
        e1 = bucket[j]
        e2 = bucket[j + 1]
        values = set()
        while len(values) &lt; 2:
            p.recvuntil(b"Enter your choice:")
            p.sendline(b"1")
            p.recvuntil(b"spaces: ")
            p.sendline(" ".join([str(e1), str(e2)] * 128).encode())
            result = p.recvline()
            value = int(result.split()[-1])
            values.add(value)
            print(value)

        # we know that {oracle[e1], oracle[e2]} == values
        # but we don't know the order
        e3 = bucket[(j + 2) % len(bucket)]
        values2 = set()
        while len(values2) &lt; 2:
            p.recvuntil(b"Enter your choice:")
            p.sendline(b"1")
            p.recvuntil(b"spaces: ")
            p.sendline(" ".join([str(e1), str(e3)] * 128).encode())
            result = p.recvline()
            value = int(result.split()[-1])
            values2.add(value)

        # the intersection of values and values2 is oracle[e1]
        oracle[e1] = (values &amp; values2).pop()
        oracle[e2] = (values - set([oracle[e1]])).pop()
    print(oracle)

p.recvuntil(b"Enter your choice:")
p.sendline(b"2")
p.recvuntil(b"spaces: ")
p.sendline(" ".join([str(e) for e in oracle]).encode())
p.interactive()</code></pre>
<p>Flag: <code>watctf{1nd1v1du4l_p3rm5_l0v3_uniqueness}</code>.</p></div>

                <!-- added by @jiegec begin -->
                <div class="col-md-3"></div>
                <div class="col-md-9">
                  <script src="https://giscus.app/client.js"
                      data-repo="jiegec/ctf-writeups"
                      data-repo-id="MDEwOlJlcG9zaXRvcnkxNTE1MzAxODQ="
                      data-category="General"
                      data-category-id="DIC_kwDOCQgqyM4CvbYX"
                      data-mapping="pathname"
                      data-strict="1"
                      data-reactions-enabled="1"
                      data-emit-metadata="0"
                      data-input-position="top"
                      data-theme="light"
                      data-lang="en"
                      data-loading="lazy"
                      crossorigin="anonymous"
                      async>
                  </script>
                </div>
                <!-- added by @jiegec end -->
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2025 Jiajie Chen</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
